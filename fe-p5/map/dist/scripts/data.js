var app=app||{data:{species:{}}};!function(){"use strict";app.data.currentSighting="",app.data.basic=[{name:"Erithacus rubecula",lat:-33.844263,lng:151.113756},{name:"Erithacus rubecula",lat:-33.843263,lng:151.111756},{name:"Fuchsia magellanica",lat:-33.844548,lng:151.110811},{name:"Polyommatus icarus",lat:-33.845096,lng:151.113337},{name:"Geranium robertianum",lat:-33.844717,lng:151.110467},{name:"Arenaria interpres",lat:-33.844948,lng:151.111011},{name:"Marchantia polymorpha",lat:-33.845343,lng:151.110789}];var a={unknown:"images/blank.png",plants:"images/plant.png","plants-s":"images/splant.png",animals:"images/animal.png","animals-s":"images/sanimal.png","flowering plants":"images/flower.png","flowering plants-s":"images/sflower.png",insects:"images/insect.png","insects-s":"images/sinsect.png","butterflies and moths":"images/butterfly.png","butterflies and moths-s":"images/sbutterfly.png",birds:"images/bird.png","birds-s":"images/sbird.png",newUserMarker:"images/sblank.png"},e=function(a){this.binomial=a.name,this.keywords=a.name,this.sightings=[]};e.prototype.addKeyword=function(a){this.keywords+=", "+a.toLowerCase()};var n=function(e){this.name=e.name;var n={position:new google.maps.LatLng(e.lat,e.lng),title:e.name,icon:a.unknown,icons:{selected:a.newUserMarker,unselected:a.unknown},map:null};this.marker=new google.maps.Marker(n),google.maps.event.addListener(this.marker,"click",this.selection.bind(this))};n.prototype.selection=function(){app.map.toggleInfoWindow(this.name,this.marker),app.data.currentSighting===this?this.deselect(!0):this.select()},n.prototype.deselect=function(a){app.data.currentSighting="",a&&app.map.map.panTo(app.map.options.center),this.marker.getIcon()&&this.marker.setIcon(this.marker.icons.unselected),app.viewModel.photos(null)},n.prototype.select=function(){$("#addNew").fadeOut(),app.data.currentSighting&&app.data.currentSighting.deselect(),app.data.currentSighting=this,this.marker.getIcon()&&this.marker.setIcon(this.marker.icons.selected),app.viewModel.photos(app.data.species[this.name].pics)},app.data.addNewSpecies=function(a,n){var t=new e(a),i=t.binomial;app.data.species[i]||(app.data.species[i]=t),n&&(c(i),p(i,n))},app.data.addNewSighting=function(a,e){var t=new n(a),i=t.name;app.data.species[i]&&app.data.species[i].sightings.push(t),e&&e()};var t=function(){for(var a=app.data.basic,e=0,n=a.length;n>e;e++)app.data.addNewSpecies(a[e]),app.data.addNewSighting(a[e])},i=function(a,e){if(-1===a.indexOf(e))return'Property "'+e+'" not found';var n=a.substring(a.indexOf(e)+e.length).replace(/ /g,"");return n.substring(n.indexOf("=")+1,n.indexOf("\n"))},s=function(a){var e={};switch(i(a,"regnum")){case"[[Plant]]ae":switch(e.kingdom="plants",i(a,"unranked_divisio")){case"[[Angiosperms]]":e.division="flowering plants"}break;case"[[Animal]]ia":switch(e.kingdom="animals",i(a,"classis")){case"[[Insect]]a":switch(e["class"]="insects",i(a,"ordo")){case"[[Lepidoptera]]":e.order="butterflies and moths"}break;case"[[bird|Aves]]":case"[[Aves]]":e["class"]="birds"}break;default:e.kingdom="unknown"}return e},r=function(e){var n=e.query.pages,t=e.query.redirects||null,i=function(a){return a.replace(/<\/?b>/g,"").toLowerCase()};for(var r in n){if("-1"===r)return;var p=n[r].title;if(t)for(var o=0,c=t.length;c>o;o++)p===t[o].to&&(p=t[o].from);var l=n[r].revisions[0]["*"],d=n[r].extract,g=n[r].canonicalurl,m=$("<div>").append($("<h3>").text(p)).append($("<div>").html(d).addClass("extract")).append($("<p>").append($("<a>").attr("href",g).text("[Wikipedia]"))),u=s(l);"unknown"===u.kingdom&&alert("That doesn't appear to be a valid binomial...\n(according to Wikipedia) \n\n...maybe you've discovered a new life form?");var h=d.match(/<b>(.*?)<\/b>/g).map(i),f=app.data.species[p];f.wm={iwHTML:m[0],url:g,taxon:u,commonNames:h};for(var w in u)f.addKeyword(u[w]);for(var o=0,c=h.length;c>o;o++)f.addKeyword(h[o]);for(var v,k=f.sightings,b=u.order||u["class"]||u.division||u.kingdom,o=0,c=k.length;c>o;o++)v=k[o].marker,v.icons.selected=a[b+"-s"],v.icons.unselected=a[b],v.setIcon(a[b])}},p=function(a,e){var n="https://en.wikipedia.org//w/api.php?action=query&format=json&redirects=&prop=revisions|extracts|info&rvprop=content&rvsection=0&exlimit=max&exintro=&excontinue=true&inprop=url",t=a?[a]:app.data.basic.map(function(a){return a.name}),i=t.join("|");jQuery.ajax({url:n+"&titles="+i,dataType:"jsonp",success:function(a){r(a),e&&e()}})},o=function(a){for(var e,n=a.photos.photo,t=[],i=0,s=n.length;s>i;i++){var r={};e=n[i],r.src=e.url_q,r.title=e.title||"untitled",r.url="https://www.flickr.com/photos/"+e.owner+"/"+e.id,t.push(r)}return t},c=function(a){var e="8b7814a6caaa9aaedffe891d3fa97cfa",n="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+e+"&safe_search=1&content_type=1&extras=url_q&per_page=6&page=1&format=json&nojsoncallback=1";jQuery.ajax({url:n+"&text="+a,dataType:"json",success:function(e){app.data.species[a]&&(app.data.species[a].pics=o(e))}})},l=function(){for(var a=app.data.basic.map(function(a){return a.name}),e=0,n=a.length;n>e;e++)c(a[e])},d=function(){t(),p(),l()};d()}();