var app=app||{};!function(){"use strict";var e=function(e){this.species=ko.observable(e.binomial),this.keywords=e.keywords.toLowerCase(),this.isVisible=ko.observable(!1),this.sightings=e.sightings,this.drawMapMarker=function(){var e;e=this.isVisible()?app.map.map:null;for(var t=0,n=this.sightings.length;n>t;t++)this.sightings[t].marker.setMap(e)},this.taxon=function(){if(e.wm){var t=[],n=e.wm.taxon;for(var a in n)t.push(a+": "+n[a]);return t.join(" | ")}return""}.bind(this)(),this.commonNames=e.wm?"Also known as: "+e.wm.commonNames.join(", ")+".":""},t=function(t){this.speciesNames=[],this.species=ko.observableArray(function(n){n=n||t.species;var a=[];for(var i in n)a.push(new e(n[i])),this.speciesNames.push(n[i].binomial);return a}.bind(this)()),this.filterStr=ko.observable(""),this.tempFilterStr="",this.filteredSpecies=ko.computed(function(){return this.species().filter(function(e){return e.isVisible(e.keywords.indexOf(this.filterStr().toLowerCase())>=0),e.isVisible()}.bind(this))}.bind(this)),this.photos=ko.observableArray(),this.listClick=function(e){this.toggleFilterStr(e.species())}.bind(this),this.mapMarkerBounce=function(e){for(var t=e.sightings,n=0,a=t.length;a>n;n++)t[n].marker.setAnimation(google.maps.Animation.BOUNCE)},this.mapMarkerPuncture=function(e){for(var t=e.sightings,n=0,a=t.length;a>n;n++)t[n].marker.setAnimation(null)},this.toggleFilterStr=function(e){this.filterStr()===e?this.filterStr(this.tempFilterStr):(this.tempFilterStr=this.filterStr(),this.filterStr(e))}};app.map={options:{center:{lat:-33.844,lng:151.112},zoom:17,mapTypeId:google.maps.MapTypeId.TERRAIN,disableDefaultUI:!0},toggleInfoWindow:function(e,t){var a=n.getContent(),i=app.data.species[e].wm?app.data.species[e].wm.iwHTML:e;a!==i?(n.setContent(i),n.open(this.map,t)):a===i&&app.data.currentSighting.marker===t?($("#addNew").fadeIn(),n.setContent(""),n.close()):(n.close(),n.open(this.map,t))}};var n=new google.maps.InfoWindow({content:""});google.maps.event.addListener(n,"closeclick",function(){$("#addNew").fadeIn(),n.setContent(""),app.viewModel.photos(null),app.data.currentSighting.deselect(!0),app.data.currentSighting=""}),app.newEntryInfoWindow=null,app.newEntryMarker=null,app.saveNewSighting=function(){var t=$("#search")[0].value;if(t.length<3)return void alert("That doesn't appear to be a valid name.");t=t[0].toUpperCase()+t.slice(1);var n=app.newEntryMarker.getPosition(),a={name:t,lat:n.A,lng:n.F},i=app.viewModel.speciesNames.indexOf(t),s=function(){if(-1===i)app.viewModel.species().push(new e(app.data.species[t])),app.viewModel.speciesNames.push(t),(void 0===app.data.species[t].wm||"unknown"===app.data.species[t].wm.taxon.kingdom)&&(app.viewModel.species().pop(),app.viewModel.speciesNames.pop(),delete app.data.species[t]);else{var n=app.data.species[t].sightings[0].marker.icons,a=app.data.species[t].sightings.pop();a.marker.icons.unselected=n.unselected,a.marker.icons.selected=n.selected,a.marker.setIcon(n.unselected),app.data.species[t].sightings.push(a)}app.viewModel.filterStr("//"),app.viewModel.filterStr("")};-1===i?(app.data.addNewSpecies(a,s),app.data.addNewSighting(a)):app.data.addNewSighting(a,s),app.newEntryInfoWindow.setContent(""),app.newEntryMarker.setMap(null),$("#saveNew").fadeOut(),$("#addNew").fadeIn("slow")},app.newSighting=function(){$("#addNew").fadeOut(),$("#saveNew").fadeIn("slow"),app.data.currentSighting&&(app.data.currentSighting.deselect(),n.close()),this.map.map.panTo(this.map.options.center),app.newEntryMarker=new google.maps.Marker({position:this.map.options.center,map:app.map.map,draggable:!0,icon:"images/sblank.png",title:"Drag me!"}),app.newEntryInfoWindow=new google.maps.InfoWindow,app.newEntryInfoWindow.setContent($("#newSightingInfoWindow").html()),app.newEntryInfoWindow.open(this.map.map,app.newEntryMarker),google.maps.event.addListener(app.newEntryInfoWindow,"closeclick",function(){$("#saveNew").fadeOut(),$("#addNew").fadeIn("slow"),app.newEntryInfoWindow.close(),app.newEntryMarker.setMap(null)}),google.maps.event.addListener(app.newEntryMarker,"click",app.saveNewSighting)},$("#addNew").on({click:function(){app.newSighting()}}),$("#saveNew").on({click:function(){app.saveNewSighting()}}),$("#saveNew").fadeOut();var a=function(){app.map.map=new google.maps.Map(document.getElementById("map-canvas"),app.map.options)};google.maps.event.addDomListener(window,"load",a),window.onload=function(){app.viewModel=new t(app.data),ko.applyBindings(app.viewModel)}}();